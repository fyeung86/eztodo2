<head>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone-min.js"></script>
</head>

<link rel="stylesheet" type="text/css" href="/static/css/main.css"/>

<style>


</style>

<body>
  <div id="myDIV" class="header">
    <h2>Simple To Do List</h2>
    <input type="text" id="taskInput" placeholder="Your Future Task...">
    <span class="addBtn">New Task</span>
  </div>

  <div id="container"></div>

  <ul id="myUL"></ul>


  <!-- Templates -->
  <script type="text/template" id="item-template">
    <div class="view">
      <span class="check"> ✔ </span>
      <span class="close"> ✘ </span>
      <label class="action"> <%- action %> </label>
      <input class="updateAction" value="<%- action %>">
    </div>
  </script>

</body>
<script>
  var app = {};

  var TodoModel = Backbone.Model.extend({
    idAttribute: 'task_id',
    urlRoot: '/tasks'
  });

  var TodoCollection = Backbone.Collection.extend({
    model: TodoModel,
    url: '/tasks',
    parse: function (response) {
      var self = this;
      response.tasks.forEach(function (item) {
        item.completed = false;
        self.push(item)
      })
      return this.models;
    }
  });

  var TodoView = Backbone.View.extend({
    tagName: 'li',
    template: _.template($('#item-template').html()),
    render: function(){
      this.$el.html(this.template(this.model.toJSON()));
      this.input = this.$('.updateAction');
      return this;
    },
    initialize: function(){
      this.model.on('change', this.render, this);
      this.model.on('destroy', this.remove, this);
    },
    events: {
      'dblclick .action' : 'edit',
      'keypress .updateAction' : 'updateOnEnter',
      'blur .updateAction' : 'close',
      'click .toggle': 'toggleCompleted',
      'click .close': 'destroy',
      'click .check': 'check'
    },
    edit: function(){
      this.$el.addClass('editing');
      this.input.focus();
    },
    close: function(){
      var value = this.input.val().trim();
      if(value) {
        this.model.save({action: value});
      }
      this.$el.removeClass('editing');
    },
    updateOnEnter: function(e){
      if(e.which == 13){
        this.close();
      }
    },
    destroy: function () {
        this.model.destroy();
    },
    check: function () {
        this.$el.toggleClass('checked');
    }
  });

  var AppView = Backbone.View.extend({
    el: '#myDIV',
    initialize: function(){
      var todoList = this.todoList = new TodoCollection();
      this.todoList.fetch({
        success: function (item) {
          todoList.models.forEach(function (item) {
            console.log(item);
            var view = new TodoView({model: item});
            $('#myUL').append(view.render().el);
          })
        }
      })
      this.render();
    },
    events: {
      'click .addBtn': 'create'
    },
    create: function () {
      var action = $('#taskInput').val();
      if (action === '') {
        return;
      } 
      this.todoList.create({'action': action}, {
        success: function (model) {
          model.completed = false;
          var view = new TodoView({model: model});
          $('#myUL').append(view.render().el);
          $('#taskInput').val('');
        }
      });
    }
  });

  var appView = new AppView();
</script>


